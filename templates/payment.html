<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/css/payment.css" />
    <title>C-AIR</title>
    <!-- payment.html - C-AIR 웹사이트 결제 페이지 -->
  </head>

  <body data-user-logged-in="{{ 'true' if user_name and user_name != '회원' else 'false' }}" data-user-name="{{ user_name if user_name else '' }}">
    <!-- Header Area -->
    <header>
      <nav>
        <div class="main-logo">
          <img src="/static/assets/logos/logo-main.png" alt="C-AIR Logo" />
        </div>

        <ul class="nav-menu">
          <li class="nav-menu-item cta"><a href="{{ url_for('main.search_page') }}">예약</a></li>
          <li class="nav-menu-item cta"><a href="{{ url_for('main.history_search_page') }}" class="active">예약 내역 조회</a></li>
          {% if session.user_role == 'admin' %}
          <li class="nav-menu-item"><a href="{{ url_for('main.statistics_page') }}">통계</a></li>
          {% endif %}
          {% if session.user_cno %}
          <li class="nav-user-info">{{ session.user_name }}님 안녕하세요!</li>
          <li class="nav-menu-item user"><a href="{{ url_for('api.logout') }}">로그아웃</a></li>
          {% else %}
          <li class="nav-menu-item user"><a href="{{ url_for('main.login_page') }}">로그인</a></li>
          {% endif %}
        </ul>
      </nav>
    </header>

    <!-- Main Content Area -->
    <main>
      <!-- Hero Section -->
      <section id="hero">
        <div class="hero-image-wrapper">
          <img src="/static/assets/images/image-travel.jpg" class="hero-image" alt="Airplane" />
        </div>
      </section>

      <!-- Payment Section -->
      <section id="reservation">
        <div class="reservation-title-section">
          <div class="reservation-title">운항편 예약</div>
        </div>

        <div class="payment-info-section">
          <span>아래의 운항편이 예약 및 결제하실 운항편이 맞는지 최종 확인해주세요.</span>
        </div>

        <div class="reservation-info-section">
          <span>출발날짜시간</span>
          <span>출발공항</span>
          <span>도착날짜시간</span>
          <span>도착공항</span>
          <span>운항편명 항공사</span>
          <span>좌석등급</span>
          <span>남은 좌석 수</span>
          <span>요금</span>
        </div>

        <div class="item-section" id="selectedFlightSection">
          <!-- 선택된 항공편 정보가 여기에 동적으로 표시됩니다 -->
        </div>

        <div class="cta-section">
          <button class="btn-payment" onclick="processPayment()">결제하기</button>
        </div>
      </section>
      <button class="btn-floating" onclick="goBack()">
        <img src="/static/assets/icons/icon-arrow-left.svg" />
      </button>
    </main>

    <script>
      // 서버에서 전달받은 사용자 정보
      const userInfo = {
        isLoggedIn: document.body.dataset.userLoggedIn === 'true',
        userName: document.body.dataset.userName || null
      };

      // 페이지 로드 시 선택된 항공편 정보 표시
      document.addEventListener('DOMContentLoaded', function() {
        displaySelectedFlight();
      });

      // 선택된 항공편 정보 표시 함수
      function displaySelectedFlight() {
        const selectedFlight = JSON.parse(sessionStorage.getItem('selectedFlight'));
        
        if (!selectedFlight) {
          alert('선택된 항공편 정보가 없습니다. 다시 선택해주세요.');
          window.location.href = '/reservation';
          return;
        }

        const itemSection = document.getElementById('selectedFlightSection');
        
        // 항공편 정보를 표시할 HTML 생성
        const flightHTML = `
          <div class="item">
            <span>${selectedFlight.departure_date_time}</span>
            <span>${getAirportName(selectedFlight.departure_airport)}</span>
            <span>${selectedFlight.arrival_date_time}</span>
            <span>${getAirportName(selectedFlight.arrival_airport)}</span>
            <span>${selectedFlight.flight_number} ${selectedFlight.airline}</span>
            <span>${getSeatClassName(selectedFlight.seat_class)}</span>
            <span>${selectedFlight.number_of_seats}</span>
            <span>${selectedFlight.price.toLocaleString()}원</span>
          </div>
        `;
        
        itemSection.innerHTML = flightHTML;
      }

      // 공항 코드를 한국어 이름으로 변환 (서버 사이드 매핑과 일치)
      function getAirportName(airportCode) {
        const airportNames = {
          'ICN': '인천',
          'JFK': '뉴욕'
        };
        return airportNames[airportCode] || airportCode;
      }

      // 좌석 등급을 한국어로 변환 (서버 사이드 매핑과 일치)
      function getSeatClassName(seatClass) {
        const seatClassNames = {
          'Business': '비즈니스',
          'Economy': '이코노미'
        };
        return seatClassNames[seatClass] || seatClass;
      }

      // 결제 처리 함수
      function processPayment() {
        const selectedFlight = JSON.parse(sessionStorage.getItem('selectedFlight'));
        
        if (!selectedFlight) {
          alert('선택된 항공편 정보가 없습니다.');
          return;
        }

        // 로그인 상태 확인
        if (!userInfo.isLoggedIn) {
          alert('로그인이 필요한 서비스입니다.');
          window.location.href = '/login';
          return;
        }

        // 결제 확인
        if (!confirm('선택하신 항공편으로 예약을 진행하시겠습니까?')) {
          return;
        }

        // 서버에 예약 요청 전송
        fetch('/api/reserve', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            flight_number: selectedFlight.flight_number,
            departure_date_time: selectedFlight.departure_date_time,
            seat_class: selectedFlight.seat_class,
            price: selectedFlight.price
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 예약 성공 시 세션 스토리지에서 선택된 항공편 정보 삭제
            sessionStorage.removeItem('selectedFlight');
            
            // 이메일 전송 결과 알림
            let successMessage = data.message;
            if (data.email_sent) {
              successMessage += '\n\n이메일로 예약 확인서가 전송되었습니다.';
            } else {
              successMessage += '\n\n이메일 전송에 실패했습니다: ' + data.email_message;
            }
            
            alert(successMessage);
            
            // 결제 완료 페이지로 이동
            window.location.href = '/payment-complete';
          } else {
            alert('예약에 실패했습니다: ' + (data.message || '알 수 없는 오류가 발생했습니다.'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('예약 처리 중 오류가 발생했습니다.');
        });
      }

      // 뒤로 가기 함수
      function goBack() {
        window.history.back();
      }
    </script>
  </body>
</html>
